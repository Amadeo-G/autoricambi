// catalog.js - Modificado para integración de Detalle Dinámico

const EXCEL_FILE_PATH = '/Filtros.xlsx';
const R2_BASE_URL = 'https://pub-4a74b73ccfa3493ebcfc17e92136dcf4.r2.dev';

let allData = [];
let filteredData = [];

const excelWorker = new Worker('/src/js/excel-worker.js');

// Referencias a nuevos elementos de la interfaz
const els = {
    tbody: document.getElementById('tableBody'),
    sideImg: document.getElementById('side-image'),
    sideTitle: document.getElementById('side-title'),
    sideCode: document.getElementById('side-code'),
    techFooter: document.getElementById('tech-footer'),
    techSpecs: document.getElementById('tech-specs'),
    techEquiv: document.getElementById('tech-equiv'),
    techApp: document.getElementById('tech-app'),
    techPrice: document.getElementById('tech-price')
};

excelWorker.onmessage = function (e) {
    const { type, data } = e.data;
    if (type === 'DONE') {
        allData = data;
        renderTable(allData);
    }
};

function renderTable(data) {
    if (!els.tbody) return;
    els.tbody.innerHTML = '';

    data.forEach(item => {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-blue-50 cursor-pointer transition-all border-b text-sm";
        
        tr.innerHTML = `
            <td class="px-4 py-3 font-bold text-blue-900">${item.codigo}</td>
            <td class="px-4 py-3 text-gray-700">${item.descripcion}</td>
            <td class="px-4 py-3 text-gray-500">${item.marca || 'N/A'}</td>
            <td class="px-4 py-3 text-right font-bold text-gray-800">${item.precio}</td>
        `;

        // EVENTO CLIC: SINCRONIZACIÓN
        tr.onclick = () => {
            // 1. Resaltar fila
            document.querySelectorAll('#tableBody tr').forEach(r => r.classList.remove('selected-row'));
            tr.classList.add('selected-row');

            // 2. Actualizar Imagen Lateral (.webp)
            els.sideImg.style.opacity = '0';
            setTimeout(() => {
                els.sideImg.src = `${R2_BASE_URL}/${item.codigo}.webp`;
                els.sideImg.style.opacity = '1';
            }, 100);
            
            els.sideImg.onerror = () => { 
                els.sideImg.src = "https://via.placeholder.com/400?text=Imagen+No+Disponible"; 
            };
            
            els.sideTitle.innerText = item.descripcion;
            els.sideCode.innerText = `CÓDIGO: ${item.codigo}`;

            // 3. Mostrar Footer y cargar datos técnicos
            els.techFooter.classList.add('show-footer');
            els.techSpecs.innerText = item.caracteristicas || "Especificación técnica disponible en catálogo físico.";
            els.techEquiv.innerText = item.equivalentes || "No se registran cruces para este artículo.";
            els.techApp.innerText = `${item.rubro || ''} / ${item.marca || ''}`;
            els.techPrice.innerText = `$ ${item.precio}`;
        };

        els.tbody.appendChild(tr);
    });
}

// Lógica de carga inicial
fetch(EXCEL_FILE_PATH)
    .then(res => res.arrayBuffer())
    .then(buffer => {
        excelWorker.postMessage({ type: 'PARSE_EXCEL', data: buffer });
    });